{% extends "admin_base.html" %}

{% block title %}Knowledge Base Management{% endblock %}

{% block content %}
<h1>Knowledge Base Management</h1>

<!-- Status Messages -->
{% if request.query_params.get("upload_success") %}
    <p class="status-message success">Document uploaded and ingestion started successfully.</p>
{% endif %}
{% if request.query_params.get("upload_error") %}
    <p class="status-message error">
        File upload failed:
        {% if request.query_params.get("upload_error") == "nofile" %} No file selected.
        {% elif request.query_params.get("upload_error") == "dbmanager" %} Database service unavailable.
        {% elif request.query_params.get("upload_error") == "nodata" %} File processed but contained no valid data/chunks.
        {% elif request.query_params.get("upload_error") == "server" %} Internal server error during processing. Check logs.
        {% else %} Unknown error.
        {% endif %}
    </p>
{% endif %}
 {% if request.query_params.get("delete_success") %}
    <p class="status-message success">Tracking record deleted successfully. Note: Vectors may still exist.</p>
{% endif %}
{% if request.query_params.get("delete_error") %}
    <p class="status-message error">
        Failed to delete tracking record:
        {% if request.query_params.get("delete_error") == "notfound" %} Record not found.
        {% else %} Internal server error.
        {% endif %}
    </p>
{% endif %}

<h2>Upload New Document</h2>
<p class="warning">Note: Uploading adds the document to the vector store. Deleting here only removes the tracking record, not the vectors themselves.</p>
<form action="/admin/kb/upload" method="post" enctype="multipart/form-data">
    <div>
        <label for="file">Select File (.pdf, .txt, .csv, .md, etc.):</label>
        <input type="file" id="file" name="file" accept=".pdf,.txt,.csv,.md,.json" required>
    </div>
    <button type="submit">Upload and Ingest</button>
</form>

<h2>Uploaded Document Records</h2>
<table>
    <thead>
        <tr>
            <th>Filename</th>
            <th>Uploaded At (UTC)</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for doc in documents %}
        <tr>
            <td>{{ doc.filename }}</td>
            <td>{{ doc.uploaded_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td class="actions">
                 <form action="/admin/kb/{{ doc.id }}/delete_record" method="post" onsubmit="return confirm('Are you sure you want to delete this TRACKING record? This action cannot be undone and does NOT remove the document content from the knowledge base vectors.');">
                    <button type="submit" class="delete">Delete Record</button>
                </form>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="3">No documents uploaded via admin panel yet.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}